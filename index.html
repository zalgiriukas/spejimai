<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Žalgirio Eurolygos spėjimų žaidimas</title>
  <style>
    :root{
      --bg:#0f1220; --card:#171a2c; --muted:#a7b0c0; --accent:#2bd67b; --danger:#ff5d5d; --text:#e8eef7;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}
    .container{max-width:980px;margin:24px auto;padding:0 16px;position:relative}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:clamp(20px,3.6vw,28px);margin:0}
    .card{background:var(--card);border:1px solid #22263d;border-radius:12px;padding:16px}
    .row{display:grid;grid-template-columns:200px 1fr;gap:12px;align-items:center}
    @media (max-width:640px){.row{grid-template-columns:1fr}}
    label.name{font-weight:600}
    input[type=text]{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #2a2f4a;background:#0e1122;color:var(--text)}
    input[disabled]{opacity:.6}
    .hint{color:var(--muted);font-size:12px;margin-top:4px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .btns{display:flex;gap:8px;flex-wrap:wrap}
    button{appearance:none;border:none;cursor:pointer;border-radius:10px;padding:10px 14px;font-weight:600;background:var(--accent);color:#0b1a0f;box-shadow:0 0 0 1px #1a2b22 inset,0 6px 18px rgba(43,214,123,.25)}
    button.secondary{background:#2b3153;color:var(--text);box-shadow:0 0 0 1px #2a2f4a inset}
    button.danger{background:var(--danger);color:#290a0a}
    button:disabled{opacity:.6;cursor:not-allowed}
    .tiny-reset{position:static;margin:24px auto 0 auto;display:block;font-size:11px;line-height:1;padding:6px 8px;border-radius:6px;background:#2b3153;color:#cbd3e6;border:1px solid #2a2f4a;opacity:.9}
    .tiny-reset:hover{opacity:1}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #262b45;text-align:left}
    th{color:var(--muted);font-weight:600}
    .winner{background:linear-gradient(90deg, rgba(43,214,123,.15), transparent)}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700;background:#122918;color:var(--accent)}
    .note{font-size:14px;color:var(--muted)}
    details{margin-top:16px}
    summary{cursor:pointer;color:var(--muted)}
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#0e1122;border:1px solid #283055;color:var(--text);padding:10px 14px;border-radius:10px;opacity:0;transition:opacity .2s, transform .2s;pointer-events:none;z-index:999}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Žalgirio Eurolygos spėjimų žaidimas</h1>
      <div class="btns">
        <button id="btn-score" title="Suskaičiuoti taškus pagal oficialų rezultatą">Skaičiuoti taškus</button>
        <button id="btn-new" class="secondary" title="Išvalyti šio turo spėjimus, paliekant taškus">Naujos rungtynės</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <h2 style="margin-top:0">Spėjimai</h2>
        <p class="note">
          Įrašykite <b>taškų skirtumą</b> (Žalgirio persvara): pvz., <b>+7</b> – laimės 7 taškais, <b>-3</b> – pralaimės 3 taškais.<br>
          <b>Taisyklės:</b> <b>+2</b> taškai už <b>tikslų</b> pataikymą; jei tikslių nėra – artimiausi gauna <b>+1</b>.
        </p>
        <div id="guesses"></div>
      </section>

      <section class="card">
        <h2 style="margin-top:0">Oficialus rezultatas</h2>
        <div class="row" style="margin-bottom:12px">
          <label for="official" class="name">Žalgirio taškų skirtumas</label>
          <div>
            <input id="official" type="text" inputmode="numeric" placeholder="pvz. +7 arba -3" />
            <div class="hint">Įveskite oficialų taškų skirtumą po rungtynių. (Automatinio paėmimo nebėra.)</div>
          </div>
        </div>

        <h3>Turnyrinė lentelė</h3>
        <table>
          <thead>
            <tr><th>Vardas</th><th>Taškai</th><th>Paskutinis spėjimas</th></tr>
          </thead>
          <tbody id="scoreboard"></tbody>
        </table>

        <details>
          <summary>Rungtynių istorija</summary>
          <div id="history" class="hint"></div>
        </details>
      </section>
    </div>

    <button id="btn-reset" class="tiny-reset" title="Ištrinti visą istoriją ir taškus">Atstatyti viską</button>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // --- Konfig / pradiniai duomenys ---
    const PLAYERS = ["Rosita","Valdas","Virginija","Vincas","Benas","Aiguste","Karolis","Aiste","Paulius"];

    const ls = {
      read(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch{ return fallback; } },
      write(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
    };

    const state = {
      points: ls.read('points', {}),
      guesses: ls.read('guesses', {}),
      roundScored: ls.read('roundScored', false),
      history: ls.read('history', [])
    };
    PLAYERS.forEach(n => { if(!(n in state.points)) state.points[n] = 0; });

    const $guesses = document.getElementById('guesses');
    const $scoreboard = document.getElementById('scoreboard');
    const $history = document.getElementById('history');
    const $official = document.getElementById('official');

    function toast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 1800);
    }

    function parseDiff(v){
      if(typeof v !== 'string') return null;
      v = v.trim(); if(!v) return null;
      const m = v.match(/^([+\-])?\s*(\d{1,3})$/);
      if(!m) return null;
      const sign = m[1] === '-' ? -1 : 1;
      const num = parseInt(m[2], 10);
      return sign * num;
    }

    function renderGuesses(){
      $guesses.innerHTML = '';
      PLAYERS.forEach(name => {
        const row = document.createElement('div'); row.className = 'row';
        const label = document.createElement('label'); label.className = 'name'; label.textContent = name; label.setAttribute('for', `g_${name}`);

        const input = document.createElement('input');
        input.type = 'text'; input.inputMode = 'numeric'; input.placeholder = '+7 arba -3'; input.id = `g_${name}`;
        input.value = state.guesses[name] ?? '';
        input.disabled = !!state.roundScored;
        input.addEventListener('change', () => {
          state.guesses[name] = input.value.trim();
          ls.write('guesses', state.guesses);
          renderScoreboard();
        });

        const wrap = document.createElement('div');
        wrap.appendChild(input);
        const hint = document.createElement('div');
        hint.className = 'hint';
        hint.textContent = 'Vienas spėjimas: įveskite tik taškų skirtumą';
        wrap.appendChild(hint);

        row.appendChild(label);
        row.appendChild(wrap);
        $guesses.appendChild(row);
      });
    }

    function renderScoreboard(lastWinners = [], exact = []){
      $scoreboard.innerHTML = '';
      PLAYERS.forEach(name => {
        const tr = document.createElement('tr');
        if(lastWinners.includes(name)) tr.classList.add('winner');
        const tdN = document.createElement('td'); tdN.textContent = name;
        const tdP = document.createElement('td'); tdP.innerHTML = `<span class="tag">${state.points[name] ?? 0}</span>` + (exact.includes(name) ? ' <span class="hint">(+2)</span>' : '');
        const tdG = document.createElement('td'); tdG.textContent = state.guesses[name] ?? '';
        tr.append(tdN, tdP, tdG);
        $scoreboard.appendChild(tr);
      });
    }

    function renderHistory(){
      if(!state.history.length){ $history.textContent = 'Dar nėra įrašų.'; return; }
      $history.innerHTML = state.history.map(h => {
        const date = new Date(h.dateISO).toLocaleString();
        const winners = h.winners.join(', ') || '—';
        const exact = h.exact.length ? ` (tikslūs: ${h.exact.join(', ')})` : '';
        const gList = Object.entries(h.guessesSnapshot).map(([n,v])=>`${n}: ${v || '—'}`).join(' · ');
        return `<div style="margin:6px 0;padding:8px;border:1px solid #2a2f4a;border-radius:8px">`+
               `<div><b>${date}</b> · Oficialus: <b>${h.official > 0 ? '+'+h.official : h.official}</b></div>`+
               `<div>Nugalėtojai: ${winners}${exact}</div>`+
               `<div class="hint">${gList}</div>`+
               `</div>`;
      }).join('');
    }

    function scoreRound(){
      if(state.roundScored){ toast('Šis turas jau suskaičiuotas. Spauskite „Naujos rungtynės“.'); return; }
      const official = parseDiff($official.value);
      if(official === null){ toast('Įveskite teisingą oficialų skirtumą (pvz., +7 arba -3).'); return; }

      const parsed = PLAYERS.map(name => ({
        name,
        raw: (state.guesses[name] ?? '').trim(),
        val: parseDiff(state.guesses[name] ?? '')
      })).filter(x => x.val !== null);

      if(parsed.length === 0){ toast('Nėra galiojančių spėjimų.'); return; }

      let best = Infinity;
      parsed.forEach(x => { best = Math.min(best, Math.abs(x.val - official)); });
      const winners = parsed.filter(x => Math.abs(x.val - official) === best).map(x => x.name);
      const exact = parsed.filter(x => x.val === official).map(x => x.name);

      if(exact.length){ exact.forEach(n => { state.points[n] = (state.points[n] ?? 0) + 2; }); }
      else { winners.forEach(n => { state.points[n] = (state.points[n] ?? 0) + 1; }); }

      const snapshot = {};
      PLAYERS.forEach(n => { snapshot[n] = (state.guesses[n] ?? '').trim(); });
      state.history.unshift({ dateISO: new Date().toISOString(), official, winners: exact.length ? exact : winners, exact, guessesSnapshot: snapshot });

      state.roundScored = true;
      ls.write('points', state.points);
      ls.write('history', state.history);
      ls.write('roundScored', state.roundScored);

      document.querySelectorAll('#guesses input').forEach(i => i.disabled = true);

      renderScoreboard(exact.length ? exact : winners, exact);
      renderHistory();

      toast(exact.length ? `Tikslūs (+2): ${exact.join(', ')}` : `Taškas (+1): ${winners.join(', ')}`);

      // ——— serverio išsaugojimas
      saveStateToServer();
    }

    function newRound(){
      state.roundScored = false;
      PLAYERS.forEach(n => { state.guesses[n] = ''; });
      ls.write('guesses', state.guesses);
      ls.write('roundScored', state.roundScored);
      document.querySelectorAll('#guesses input').forEach(i => { i.disabled = false; i.value=''; });
      renderScoreboard([]);
      toast('Naujas turas – sėkmės!');

      // ——— serverio išsaugojimas
      saveStateToServer();
    }

    function resetAll(){
      if(!confirm('Tikrai atstatyti VISKĄ? Bus ištrinta: taškai, spėjimai, istorija.')) return;
      state.points = {}; PLAYERS.forEach(n => state.points[n] = 0);
      state.guesses = {}; state.history = []; state.roundScored = false; $official.value = '';
      ls.write('points', state.points);
      ls.write('guesses', state.guesses);
      ls.write('history', state.history);
      ls.write('roundScored', state.roundScored);
      renderGuesses();
      renderScoreboard([]);
      renderHistory();
      toast('Viskas atstatyta.');

      // ——— serverio išsaugojimas
      saveStateToServer();
    }

    // ====== Nauja: bendras saugojimas per Netlify Functions + Blobs ======

    function currentStateToJSON(){
      return {
        points: state.points,
        guesses: state.guesses,
        roundScored: state.roundScored,
        history: state.history
      };
    }

    function applyStateFromJSON(obj){
      if (!obj || typeof obj !== 'object') return;
      state.points = obj.points ?? state.points;
      state.guesses = obj.guesses ?? state.guesses;
      state.roundScored = !!obj.roundScored;
      state.history = Array.isArray(obj.history) ? obj.history : state.history;

      // cache lokaliai
      ls.write('points', state.points);
      ls.write('guesses', state.guesses);
      ls.write('roundScored', state.roundScored);
      ls.write('history', state.history);

      renderGuesses();
      renderScoreboard([]);
      renderHistory();

      if (state.roundScored) {
        document.querySelectorAll('#guesses input').forEach(i => i.disabled = true);
      }
    }

    async function loadStateFromServer(){
      try{
        const r = await fetch('/api/load', { method: 'GET' });
        if(!r.ok) throw new Error('HTTP '+r.status);
        const data = await r.json();
        applyStateFromJSON(data);
        toast('Būsena įkelta ✨');
      }catch(e){
        console.warn('load failed', e);
        // Fallback į lokalų cache (pirmą kartą bus tuščia)
        applyStateFromJSON({
          points: ls.read('points', state.points),
          guesses: ls.read('guesses', state.guesses),
          roundScored: ls.read('roundScored', state.roundScored),
          history: ls.read('history', state.history),
        });
        toast('Nepavyko įkelti iš serverio – naudojama vietinė būsena');
      }
    }

    async function saveStateToServer(){
      try{
        const headers = { 'content-type': 'application/json' };
        // Jei naudoji ADMIN_TOKEN Netlify’e, gali pridėti:
        // headers['authorization'] = 'Bearer ' + (window.ADMIN_TOKEN ?? '');

        const r = await fetch('/api/save', {
          method: 'POST',
          headers,
          body: JSON.stringify(currentStateToJSON())
        });
        if(!r.ok) throw new Error('HTTP '+r.status);
        // toast('Išsaugota ✅'); // nenervinti vartotojo – rodom tik kritiniais atvejais
      }catch(e){
        console.warn('save failed', e);
        toast('Nepavyko išsaugoti į serverį');
      }
    }

    // Init
    renderGuesses();
    renderScoreboard([]);
    renderHistory();
    // Start’e – traukiam iš serverio (jei pavyks)
    (async ()=>{ await loadStateFromServer(); })();

    // Wire buttons
    document.getElementById('btn-score').addEventListener('click', scoreRound);
    document.getElementById('btn-new').addEventListener('click', newRound);
    document.getElementById('btn-reset').addEventListener('click', resetAll);
  </script>
</body>
